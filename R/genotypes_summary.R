# Linkage map
# Genotype summary

#' @title Summary of \code{batch_x.genotypes.txt} and
#' \code{batch_1.markers.tsv} files.
#' @description Useful summary of \code{batch_x.genotypes.txt} and
#'  \code{batch_1.markers.tsv} files produced by STACKS genotypes module use 
#'  for linkage mapping.
#' @param genotypes The \code{batch_x.genotypes.txt} created by STACKS genotypes
#' module.
#' @param markers The \code{batch_1.markers.tsv} created by STACKS genotypes
#' module.
#' @param filter.monomorphic (optional) Should monomorphic loci be filtered out.
#' Default = \code{TRUE}.
#' @param filter.missing.band (optional) Should loci with missing 
#' band be filtered out. Default = \code{TRUE}.
#' @param filter.mean.log.likelihood (optional) Should a mean log likelihood 
#' filter be applied to the loci. 
#' Default = \code{FALSE}. e.g. filter.mean.log.likelihood = -10.
#' @param B (optional) Should the the segregation distortion p-value 
#' be computed with a Monte Carlo test with \code{B} replicates. 
#' For more details, see package \code{stats} function
#'  \code{chisq.test}. Default = \code{FALSE}.
#' @param filter.GOF (optional) Filer the goodness-of-fit for segregation 
#' distortion. Default = \code{FALSE}.
#' @param filter.GOF.p.value (optional) Filer the goodness-of-fit p-value of 
#' GOF segregation distortion. Default = \code{FALSE}.
#' @param ind.genotyped Number. Filter the number of individual
#' progeny required to keep the marker.
#' @param filename (optional) The name of the file written in the directory.
#' @return The function returns a list with the 
#' genotypes summary \code{$geno.sum}, joinmap markers \code{$joinmap.sum} 
#' and onemap markers \code{$onemap.sum} summary (use $ to access each 
#' components).
#' @details SIGNIFICANCE results pvalue (goodness-of-fit pvalue): 
#' <= 0.0001 = ****, <= 0.001 & > 0.0001 = ***, 
#' <= 0.01 & > 0.001 = **, <= 0.05 & > 0.01 = *.
#' @rdname genotypes_summary
#' @export
#' @import dplyr
#' @import readr
#' @details work in progress...
#' @examples
#' \dontrun{
#' work in progress...
#' }
#' @references Catchen JM, Amores A, Hohenlohe PA et al. (2011) 
#' Stacks: Building and Genotyping Loci De Novo From Short-Read Sequences. 
#' G3, 1, 171-182.
#' @references Catchen JM, Hohenlohe PA, Bassham S, Amores A, Cresko WA (2013) 
#' Stacks: an analysis tool set for population genomics. 
#' Molecular Ecology, 22, 3124-3140.
#' @author Thierry Gosselin \email{thierrygosselin@@icloud.com}

genotypes_summary <- function(genotypes, markers, filter.monomorphic = TRUE, filter.missing.band = TRUE, filter.mean.log.likelihood = FALSE, B = FALSE, filter.GOF = FALSE, filter.GOF.p.value = FALSE, ind.genotyped = 1, filename = FALSE){
  
  
  GENOTYPES <- NULL
  TYPE <- NULL
  PATTERN <- NULL
  BANDS_OBS <- NULL
  BANDS_EXP <- NULL
  POLYMORPHIC <- NULL
  MISSING_BAND <- NULL
  MEAN_LOG_LIKELIHOOD <- NULL
  CHISQ <- NULL
  GOF <- NULL
  GOF_PVALUE <- NULL
  ONEMAP <- NULL
  JOINMAP <- NULL
  TOTAL_GENOTYPES <- NULL
  
  
  genotypes.file <- read_tsv(file = genotypes, col_names = c("SQL_ID", "BATCH_ID", "LOCUS", "INDIVIDUALS", "GENOTYPES"), col_types = "iiiic", skip =1, progress = interactive())
  
  markers.file <- read_tsv(file = markers, col_names = c("SQL_ID", "BATCH_ID", "LOCUS", "TYPE", "TOTAL_GENOTYPES", "MAX", "GENOTYPE_FREQS", "SEGREGATION_DISTORTION", "MEAN_LOG_LIKELIHOOD", "GENOTYPE_MAP", "UNCORRECTED_MARKER"), skip =1, progress = interactive())
  
  geno.sum<- genotypes.file %>%
    select(LOCUS, INDIVIDUALS, GENOTYPES) %>%
    group_by(LOCUS, GENOTYPES) %>%
    summarize(COUNT=n()) %>%
    dcast(LOCUS~GENOTYPES, value.var="COUNT") %>%
    merge(markers.file, by="LOCUS") %>%
    mutate(
      PATTERN = stri_replace_all_fixed(TYPE, c("--/ab", "aa/ab", "ab/--", "ab/aa","ab/ab", "ab/ac", "ab/cd"), 
                                       c("aaxab", "aaxab", "abxaa", "abxaa", "abxab", "abxac", "abxcd"), vectorize_all=F),
      JOINMAP = stri_replace_all_fixed(TYPE, c("--/ab", "aa/ab", "ab/--", "ab/aa", "ab/ab", "ab/ac", "ab/cd"), 
                                       c("nnxnp", "nnxnp", "lmxll", "lmxll", "hkxhk", "efxeg", "abxcd"), vectorize_all=F),
      ONEMAP = stri_replace_all_fixed(TYPE, c("--/ab", "aa/ab", "ab/--", "ab/aa", "ab/ab", "ab/ac", "ab/cd"),
                                      c("D2.15", "D2.15", "D1.10", "D1.10", "B3.7", "A.2", "A.1"), vectorize_all=F),
      BANDS_EXP = ifelse(PATTERN=="abxac" | PATTERN=="abxcd", 4, ifelse(PATTERN=="abxab", 3, 2))
    ) %>%
    merge(
      genotypes.file %>% 
        select(LOCUS, INDIVIDUALS, GENOTYPES) %>%
        filter (GENOTYPES!="--") %>%
        group_by(LOCUS, GENOTYPES) %>%
        summarize(COUNT=n()) %>%
        group_by(LOCUS) %>%
        tally() %>%
        select(LOCUS, BANDS_OBS=n)
      , by="LOCUS"
    ) %>%
    mutate(
      POLYMORPHIC = ifelse(BANDS_OBS > 1, "polymorphic","monomorphic"),
      MISSING_BAND = ifelse(BANDS_OBS < BANDS_EXP, "missing_band", "all_bands")
    )
  
  
  if(filter.monomorphic == TRUE) {
    geno.sum <- geno.sum %>% filter(POLYMORPHIC == "polymorphic")
  } else{
    geno.sum <- geno.sum
    
  }
  
  if(filter.missing.band == TRUE) {
    #   filter(PATTERN == "abxcd") %>% # use this for testing 
    geno.sum <- geno.sum %>% filter(MISSING_BAND == "all_bands")
  } else {
    geno.sum <- geno.sum
  }
  
  if(filter.mean.log.likelihood == FALSE) {
    geno.sum <- geno.sum
  } else {
    geno.sum <- geno.sum %>% filter(MEAN_LOG_LIKELIHOOD >= filter.mean.log.likelihood)
  }
  
  
  # Segregation Distortion summary ---------------------------------------------
  if (B == FALSE){
    pattern.A <- geno.sum %>%
      filter(PATTERN=="abxac" | PATTERN=="abxcd") %>%
      group_by(LOCUS) %>%
      do(
        CHISQ=chisq.test(c(.$aa,.$ab, .$ac, .$bc), 
                         p = c(0.25, 0.25, 0.25, 0.25), 
                         simulate.p.value = FALSE, B = B)
      ) %>%
      mutate(
        GOF = CHISQ$statistic,
        GOF_PVALUE = CHISQ$p.value
      ) %>%
      select(-CHISQ)
    
    pattern.B <- geno.sum %>%
      filter(PATTERN=="abxab") %>%
      group_by(LOCUS) %>%
      do(
        CHISQ=chisq.test(c(.$aa,.$ab, .$bb), 
                         p = c(0.25, 0.5, 0.25), 
                         simulate.p.value = FALSE, B = B)
      ) %>%
      mutate(
        GOF = CHISQ$statistic,
        GOF_PVALUE = CHISQ$p.value
      ) %>%
      select(-CHISQ)
    
    pattern.D <- geno.sum %>%
      filter(PATTERN=="aaxab" | PATTERN=="abxaa") %>%
      group_by(LOCUS) %>%
      do(
        CHISQ=chisq.test(c(.$aa,.$ab), 
                         p = c(0.5,0.5), 
                         simulate.p.value = FALSE, B = B)
      ) %>%
      mutate(
        GOF = CHISQ$statistic,
        GOF_PVALUE = CHISQ$p.value
      ) %>%
      select(-CHISQ)
    
    chisq.data <- rbind (pattern.A, pattern.B, pattern.D)
    
    geno.sum <- geno.sum %>%
      inner_join(chisq.data, by = "LOCUS") %>%
      mutate(
        GOF=round(GOF,2),
        GOF_PVALUE=round(GOF_PVALUE, 4),
        SIGNIFICANCE = ifelse(GOF_PVALUE <= 0.0001, "****", 
                              ifelse(GOF_PVALUE <= 0.001 & GOF_PVALUE > 0.0001, "***",
                                     ifelse(GOF_PVALUE <= 0.01 & GOF_PVALUE > 0.001, "**",
                                            ifelse(GOF_PVALUE <= 0.05 & GOF_PVALUE > 0.01, "*", ""))))
      ) %>%
      arrange(LOCUS)
    
    # With monte carlo replicates
  } else {
    message("p-values computed with Monte Carlo simulations")
    
    # abxac and/or abxcd markers
    message("for abxac and/or abxcd markers")
    pattern.A <- geno.sum %>%
      filter(PATTERN=="abxac" | PATTERN=="abxcd") %>%
      group_by(LOCUS) %>%
      do(
        CHISQ=chisq.test(c(.$aa,.$ab, .$ac, .$bc), 
                         p = c(0.25, 0.25, 0.25, 0.25), 
                         simulate.p.value = TRUE, B = B)
      ) %>%
      mutate(
        GOF = CHISQ$statistic,
        GOF_PVALUE = CHISQ$p.value
      ) %>%
      select(-CHISQ)
    
    # abxab markers
    message("for abxab markers")
    
    pattern.B <- geno.sum %>%
      filter(PATTERN=="abxab") %>%
      group_by(LOCUS) %>%
      do(
        CHISQ=chisq.test(c(.$aa,.$ab, .$bb), 
                         p = c(0.25, 0.5, 0.25), 
                         simulate.p.value = TRUE, B = B)
      ) %>%
      mutate(
        GOF = CHISQ$statistic,
        GOF_PVALUE = CHISQ$p.value
      ) %>%
      select(-CHISQ)
    
    # aaxab and/or abxaa markers
    message("for aaxab and/or abxaa markers")
    pattern.D <- geno.sum %>%
      filter(PATTERN=="aaxab" | PATTERN=="abxaa") %>%
      group_by(LOCUS) %>%
      do(
        CHISQ=chisq.test(c(.$aa,.$ab), 
                         p = c(0.5,0.5), 
                         simulate.p.value = TRUE, B = B)
      ) %>%
      mutate(
        GOF = CHISQ$statistic,
        GOF_PVALUE = CHISQ$p.value
      ) %>%
      select(-CHISQ)
    
    chisq.data <- rbind (pattern.A, pattern.B, pattern.D)
    
    geno.sum <- geno.sum %>%
      inner_join(chisq.data, by = "LOCUS") %>%
      mutate(
        GOF=round(GOF,2),
        GOF_PVALUE=round(GOF_PVALUE, 4),
        SIGNIFICANCE = ifelse(GOF_PVALUE <= 0.0001, "****", 
                              ifelse(GOF_PVALUE <= 0.001 & GOF_PVALUE > 0.0001, "***",
                                     ifelse(GOF_PVALUE <= 0.01 & GOF_PVALUE > 0.001, "**",
                                            ifelse(GOF_PVALUE <= 0.05 & GOF_PVALUE > 0.01, "*", ""))))
      ) %>%
      arrange(LOCUS)
  }
  ##filter.GOF = FALSE, filter.GOF.p.value = FALSE, ind.genotyped
  # Filter goodness-of-fit
  if(filter.GOF == FALSE){
    geno.sum <- geno.sum
    
  } else {
    geno.sum <- geno.sum %>% 
      filter(GOF < filter.GOF)
  }
  
  # Filter goodness-of-fit p-value
  if(filter.GOF.p.value == FALSE){
    geno.sum <- geno.sum
    
  } else {
    geno.sum <- geno.sum %>% 
      filter(GOF_PVALUE < filter.GOF.p.value)
  }
  
  # Filter number of individuals genotyped
  if(missing (ind.genotyped) == TRUE){
    geno.sum <- geno.sum %>% 
      filter(TOTAL_GENOTYPES > 1)
  } else {
    geno.sum <- geno.sum %>% 
      filter(TOTAL_GENOTYPES > ind.genotyped)
  }
  
  
  
  # pattern summary
  joinmap.sum <- geno.sum %>%
    group_by(JOINMAP) %>%
    tally() %>%
    rename(MARKER_NUMBER = n)
  
  onemap.sum <- geno.sum %>%
    group_by(ONEMAP) %>%
    tally() %>%
    rename(MARKER_NUMBER = n)
  
  # Figures --------------------------------------------------------------------
  
  
  # Save/Write the file to the working directory--------------------------------
  if (filename == FALSE) {
    saving <- "Saving was not selected..."
  } else {
    write_tsv(geno.sum, filename, append = FALSE, col_names = TRUE)
    saving <- paste("Saving was selected, the filename:", filename, sep = " ")
  }
  
  res <- list()
  res$geno.sum <- geno.sum
  res$joinmap.sum <- joinmap.sum
  res$onemap.sum <- onemap.sum
  
  # Message at the end ---------------------------------------------------------- 
  invisible(cat(sprintf(
    "\n%s\n
Working directory:
%s",
    saving, getwd()
  )))
  return(res) 
  
}

